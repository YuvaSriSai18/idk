name: Job Alert Cron

# Schedule: Every 2 hours (0:00, 2:00, 4:00, 6:00, 8:00, 10:00, 12:00, 14:00, 16:00, 18:00, 20:00, 22:00 UTC)
on:
  schedule:
    - cron: '0 */2 * * *'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  job-alert:
    runs-on: ubuntu-latest
    name: Process Job Alerts

    steps:
      - name: Log Cron Start
        run: |
          echo "üîî [GitHub Actions Cron] Starting job alert at $(date -u)"

      - name: Call Job Alert Endpoint
        id: cron-call
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          CRON_SECRET="${{ secrets.CRON_SECRET }}"
          
          if [ -z "$BACKEND_URL" ] || [ -z "$CRON_SECRET" ]; then
            echo "‚ùå Missing required secrets: BACKEND_URL or CRON_SECRET"
            exit 1
          fi
          
          echo "üìã Configuration:"
          echo "   Backend URL: $BACKEND_URL"
          echo "   Endpoint: /api/cron/job-alert"
          echo ""
          echo "üîê Calling endpoint with authentication..."
          
          # Call the cron endpoint with x-cron-secret header
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "x-cron-secret: $CRON_SECRET" \
            "$BACKEND_URL/api/cron/job-alert")
          
          # Split response and HTTP code
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "üìä Response Status: $HTTP_CODE"
          echo ""
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Endpoint returned 200 OK"
            echo "üìù Response body:"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            
            # Extract metrics from JSON response
            STATUS=$(echo "$BODY" | jq -r '.status' 2>/dev/null || echo "unknown")
            VIDEOS=$(echo "$BODY" | jq -r '.videos_processed' 2>/dev/null || echo "0")
            JOBS=$(echo "$BODY" | jq -r '.jobs_extracted' 2>/dev/null || echo "0")
            EMAILS=$(echo "$BODY" | jq -r '.emails_sent' 2>/dev/null || echo "0")
            
            echo ""
            echo "üìà Metrics:"
            echo "   Status: $STATUS"
            echo "   Videos processed: $VIDEOS"
            echo "   Jobs extracted: $JOBS"
            echo "   Emails sent: $EMAILS"
            
            exit 0
          elif [ "$HTTP_CODE" = "403" ]; then
            echo "‚ùå Endpoint returned 403 Unauthorized"
            echo "   Check CRON_SECRET in GitHub Secrets"
            echo "   Response: $BODY"
            exit 1
          elif [ "$HTTP_CODE" = "500" ]; then
            echo "‚ùå Endpoint returned 500 Internal Server Error"
            echo "   Response: $BODY"
            exit 1
          else
            echo "‚ùå Unexpected HTTP status: $HTTP_CODE"
            echo "   Response: $BODY"
            exit 1
          fi

      - name: Cron Success
        if: success()
        run: |
          echo "üéâ [GitHub Actions Cron] Job alert completed successfully"

      - name: Cron Failure
        if: failure()
        run: |
          echo "‚ùå [GitHub Actions Cron] Job alert failed"
          exit 1
